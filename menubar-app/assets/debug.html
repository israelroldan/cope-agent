<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src https://localhost:* http://localhost:*; style-src 'unsafe-inline'">
  <title>COPE Agent Debug</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: ui-monospace, 'SF Mono', Menlo, Monaco, monospace;
      font-size: 12px;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: #252526;
      padding: 8px 12px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 13px;
      font-weight: 500;
      color: #cccccc;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f14c4c;
    }
    .status-dot.connected {
      background: #89d185;
    }
    .controls {
      display: flex;
      gap: 8px;
    }
    button {
      background: #3c3c3c;
      border: 1px solid #4c4c4c;
      color: #cccccc;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
    }
    button:hover {
      background: #4c4c4c;
    }
    .log-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }
    .log-entry {
      padding: 4px 12px;
      border-bottom: 1px solid #2d2d2d;
      display: grid;
      grid-template-columns: 90px 70px 1fr;
      gap: 12px;
      align-items: start;
    }
    .log-entry:hover {
      background: #252526;
    }
    .timestamp {
      color: #6a9955;
      font-size: 11px;
    }
    .type {
      font-weight: 500;
      font-size: 11px;
    }
    .type.request { color: #569cd6; }
    .type.response { color: #4ec9b0; }
    .type.session { color: #dcdcaa; }
    .type.error { color: #f14c4c; }
    .source {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 3px;
      margin-right: 4px;
    }
    .source.http { background: #264f78; color: #9cdcfe; }
    .source.stdio { background: #4d3d00; color: #dcdcaa; }
    .content {
      color: #d4d4d4;
      word-break: break-all;
    }
    .method {
      color: #c586c0;
    }
    .data {
      color: #9cdcfe;
      margin-left: 8px;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c6c6c;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>COPE Agent Debug Stream</h1>
    <div class="controls">
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <button onclick="clearLog()">Clear</button>
      <button onclick="reconnect()">Reconnect</button>
    </div>
  </div>
  <div class="log-container" id="logContainer">
    <div class="empty-state" id="emptyState">Connecting to debug stream...</div>
  </div>

  <script>
    const logContainer = document.getElementById('logContainer');
    const emptyState = document.getElementById('emptyState');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    let eventSource = null;
    let entries = [];

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('en-US', { hour12: false }) + '.' +
             String(date.getMilliseconds()).padStart(3, '0');
    }

    function formatData(data) {
      if (!data) return '';
      if (typeof data === 'string') return data;
      return JSON.stringify(data);
    }

    function addEntry(event) {
      emptyState.style.display = 'none';
      entries.push(event);

      const entry = document.createElement('div');
      entry.className = 'log-entry';

      const sourcePart = event.source ? `<span class="source ${event.source}">${event.source}</span>` : '';
      const methodPart = event.method ? `<span class="method">${event.method}</span>` : '';
      const dataPart = event.data ? `<span class="data">${formatData(event.data)}</span>` : '';
      const sessionPart = event.sessionId ? `[${event.sessionId.slice(0, 8)}]` : '';

      entry.innerHTML = `
        <span class="timestamp">${formatTime(event.timestamp)}</span>
        <span class="type ${event.type}">${event.type}</span>
        <span class="content">${sourcePart}${sessionPart} ${methodPart} ${dataPart}</span>
      `;

      logContainer.appendChild(entry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLog() {
      entries = [];
      logContainer.innerHTML = '<div class="empty-state">Log cleared</div>';
    }

    function setConnected(connected) {
      statusDot.className = 'status-dot' + (connected ? ' connected' : '');
      statusText.textContent = connected ? 'Connected' : 'Disconnected';
    }

    function connect() {
      if (eventSource) {
        eventSource.close();
      }

      // Try HTTPS first, fall back to HTTP
      const protocol = 'https';
      const url = `${protocol}://localhost:3847/debug`;

      try {
        eventSource = new EventSource(url);

        eventSource.onopen = () => {
          setConnected(true);
        };

        eventSource.onmessage = (e) => {
          try {
            const event = JSON.parse(e.data);
            addEntry(event);
          } catch (err) {
            console.error('Failed to parse event:', err);
          }
        };

        eventSource.onerror = (err) => {
          setConnected(false);
          console.error('EventSource error:', err);
          eventSource.close();
          // Retry in 3 seconds
          setTimeout(connect, 3000);
        };
      } catch (err) {
        setConnected(false);
        console.error('Failed to connect:', err);
        setTimeout(connect, 3000);
      }
    }

    function reconnect() {
      connect();
    }

    // Start connection
    connect();
  </script>
</body>
</html>
