<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src https://localhost:* http://localhost:*; style-src 'unsafe-inline'; script-src 'unsafe-inline'">
  <title>COPE Agent Debug</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: ui-monospace, 'SF Mono', Menlo, Monaco, monospace;
      font-size: 12px;
      background: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .header {
      background: #252526;
      padding: 8px 12px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .header h1 {
      font-size: 13px;
      font-weight: 500;
      color: #cccccc;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f14c4c;
    }
    .status-dot.connected {
      background: #89d185;
    }
    .controls {
      display: flex;
      gap: 8px;
    }
    button {
      background: #3c3c3c;
      border: 1px solid #4c4c4c;
      color: #cccccc;
      padding: 4px 10px;
      border-radius: 3px;
      font-size: 11px;
      cursor: pointer;
    }
    button:hover {
      background: #4c4c4c;
    }
    button.active {
      background: #094771;
      border-color: #1177bb;
    }

    /* Filter bar */
    .filter-bar {
      background: #252526;
      padding: 6px 12px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      flex-shrink: 0;
    }
    .filter-bar label {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }
    .filter-bar input[type="checkbox"] {
      cursor: pointer;
    }
    .view-toggle {
      margin-left: auto;
      display: flex;
      gap: 4px;
    }
    .view-toggle button {
      padding: 3px 8px;
    }

    /* Main content area */
    .main-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    .log-container {
      flex: 1;
      overflow-y: auto;
      padding: 8px 0;
    }

    /* Flat view log entry */
    .log-entry {
      padding: 4px 12px;
      border-bottom: 1px solid #2d2d2d;
      display: grid;
      grid-template-columns: 80px 80px 90px 1fr;
      gap: 8px;
      align-items: start;
      cursor: pointer;
    }
    .log-entry:hover {
      background: #252526;
    }
    .log-entry.selected {
      background: #094771;
    }

    /* Tree view styles */
    .tree-view .log-entry {
      display: flex;
      gap: 8px;
      padding-left: 12px;
    }
    .tree-node {
      border-left: 1px solid #3c3c3c;
      margin-left: 12px;
      padding-left: 0;
    }
    .tree-node > .log-entry {
      padding-left: 12px;
    }
    .tree-node.collapsed > .tree-node {
      display: none;
    }
    .tree-toggle {
      width: 16px;
      height: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #888;
      flex-shrink: 0;
      font-size: 10px;
    }
    .tree-toggle:hover {
      color: #fff;
    }
    .tree-toggle.empty {
      visibility: hidden;
    }

    /* Tree root styling */
    .tree-root {
      margin-bottom: 8px;
      border: 1px solid #3c3c3c;
      border-radius: 4px;
      margin: 4px 8px;
    }
    .tree-root > .log-entry {
      background: #252526;
      border-radius: 4px 4px 0 0;
      border-bottom: 1px solid #3c3c3c;
    }
    .tree-root.collapsed > .log-entry {
      border-radius: 4px;
      border-bottom: none;
    }
    .tree-root > .tree-children {
      padding: 4px 0;
    }
    .tree-root.collapsed > .tree-children {
      display: none;
    }

    .timestamp {
      color: #6a9955;
      font-size: 11px;
      flex-shrink: 0;
      width: 80px;
    }

    /* Category badges */
    .category {
      font-size: 10px;
      padding: 1px 4px;
      border-radius: 3px;
      text-transform: uppercase;
      font-weight: 500;
      flex-shrink: 0;
    }
    .category.mcp { background: #264f78; color: #9cdcfe; }
    .category.orchestrator { background: #4d3d00; color: #dcdcaa; }
    .category.specialist { background: #3d4d00; color: #b5cea8; }
    .category.tool { background: #4d003d; color: #c586c0; }
    .category.system { background: #3c3c3c; color: #9cdcfe; }

    /* Event type colors */
    .type {
      font-weight: 500;
      font-size: 11px;
      flex-shrink: 0;
      width: 85px;
    }
    .type.request { color: #569cd6; }
    .type.response { color: #4ec9b0; }
    .type.session { color: #dcdcaa; }
    .type.error { color: #f14c4c; }
    .type.turn { color: #ce9178; }
    .type.spawn { color: #c586c0; }
    .type.tool_call { color: #569cd6; }
    .type.tool_result { color: #4ec9b0; }

    /* Source badges */
    .source {
      font-size: 9px;
      padding: 1px 3px;
      border-radius: 2px;
      margin-right: 4px;
      opacity: 0.7;
    }
    .source.http { background: #264f78; color: #9cdcfe; }
    .source.stdio { background: #4d3d00; color: #dcdcaa; }
    .source.cli { background: #3d4d00; color: #b5cea8; }
    .source.agent { background: #4d003d; color: #c586c0; }

    .content {
      color: #d4d4d4;
      word-break: break-word;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      flex: 1;
      min-width: 0;
    }
    .specialist {
      color: #4ec9b0;
      font-weight: 500;
    }
    .method {
      color: #c586c0;
    }
    .data {
      color: #9cdcfe;
      font-size: 11px;
      opacity: 0.8;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c6c6c;
    }

    /* Request ID badge */
    .request-id {
      font-size: 9px;
      color: #888;
      font-family: monospace;
    }

    /* Detail panel */
    .detail-panel {
      width: 0;
      background: #252526;
      border-left: 1px solid #3c3c3c;
      overflow: hidden;
      transition: width 0.2s ease;
      display: flex;
      flex-direction: column;
    }
    .detail-panel.open {
      width: 400px;
    }
    .detail-header {
      padding: 8px 12px;
      border-bottom: 1px solid #3c3c3c;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    .detail-header h2 {
      font-size: 12px;
      font-weight: 500;
      color: #cccccc;
    }
    .detail-close {
      background: none;
      border: none;
      color: #888;
      font-size: 16px;
      cursor: pointer;
      padding: 0 4px;
    }
    .detail-close:hover {
      color: #fff;
    }
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    .detail-section {
      margin-bottom: 16px;
    }
    .detail-section-title {
      font-size: 10px;
      text-transform: uppercase;
      color: #888;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .detail-field {
      margin-bottom: 8px;
    }
    .detail-field-name {
      color: #9cdcfe;
      font-size: 11px;
    }
    .detail-field-value {
      color: #ce9178;
      font-size: 11px;
      margin-left: 8px;
    }
    .detail-json {
      background: #1e1e1e;
      border-radius: 4px;
      padding: 10px;
      overflow-x: auto;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .json-key { color: #9cdcfe; }
    .json-string { color: #ce9178; }
    .json-number { color: #b5cea8; }
    .json-boolean { color: #569cd6; }
    .json-null { color: #569cd6; }
    .json-bracket { color: #d4d4d4; }
  </style>
</head>
<body>
  <div class="header">
    <h1>COPE Agent Debug Stream</h1>
    <div class="controls">
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnected</span>
      </div>
      <button onclick="clearLog()">Clear</button>
      <button onclick="reconnect()">Reconnect</button>
    </div>
  </div>
  <div class="filter-bar">
    <span style="color: #6c6c6c;">Filter:</span>
    <label><input type="checkbox" id="filterMcp" checked> MCP</label>
    <label><input type="checkbox" id="filterOrchestrator" checked> Orchestrator</label>
    <label><input type="checkbox" id="filterSpecialist" checked> Specialist</label>
    <label><input type="checkbox" id="filterTool" checked> Tool</label>
    <label><input type="checkbox" id="filterSystem" checked> System</label>
    <div class="view-toggle">
      <button id="viewFlat" class="active" onclick="setView('flat')">Flat</button>
      <button id="viewTree" onclick="setView('tree')">Tree</button>
    </div>
  </div>
  <div class="main-content">
    <div class="log-container" id="logContainer">
      <div class="empty-state" id="emptyState">Connecting to debug stream...</div>
    </div>
    <div class="detail-panel" id="detailPanel">
      <div class="detail-header">
        <h2>Event Details</h2>
        <button class="detail-close" onclick="closeDetail()">×</button>
      </div>
      <div class="detail-content" id="detailContent">
      </div>
    </div>
  </div>

  <script>
    const logContainer = document.getElementById('logContainer');
    const emptyState = document.getElementById('emptyState');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const detailPanel = document.getElementById('detailPanel');
    const detailContent = document.getElementById('detailContent');
    let eventSource = null;
    let entries = [];
    let selectedIndex = -1;
    let currentView = 'flat'; // 'flat' or 'tree'

    // Filter checkboxes
    const filters = {
      mcp: document.getElementById('filterMcp'),
      orchestrator: document.getElementById('filterOrchestrator'),
      specialist: document.getElementById('filterSpecialist'),
      tool: document.getElementById('filterTool'),
      system: document.getElementById('filterSystem'),
    };

    // Add filter change listeners
    Object.values(filters).forEach(checkbox => {
      checkbox.addEventListener('change', rerender);
    });

    function setView(view) {
      currentView = view;
      document.getElementById('viewFlat').classList.toggle('active', view === 'flat');
      document.getElementById('viewTree').classList.toggle('active', view === 'tree');
      logContainer.classList.toggle('tree-view', view === 'tree');
      rerender();
    }

    function formatTime(isoString) {
      const date = new Date(isoString);
      return date.toLocaleTimeString('en-US', { hour12: false }) + '.' +
             String(date.getMilliseconds()).padStart(3, '0');
    }

    function formatData(data) {
      if (!data) return '';
      if (typeof data === 'string') return data;
      const str = JSON.stringify(data);
      return str.length > 50 ? str.substring(0, 50) + '...' : str;
    }

    function getTypeEmoji(type) {
      return {
        'request': '→',
        'response': '←',
        'session': '◉',
        'error': '✗',
        'turn': '↻',
        'spawn': '⚡',
        'tool_call': '⚙',
        'tool_result': '✓',
      }[type] || '•';
    }

    function shouldShow(event) {
      const category = event.category || 'system';
      const filter = filters[category];
      return filter ? filter.checked : true;
    }

    // Syntax highlight JSON
    function highlightJson(obj, indent = 0) {
      const spaces = '  '.repeat(indent);

      if (obj === null) {
        return '<span class="json-null">null</span>';
      }
      if (typeof obj === 'boolean') {
        return `<span class="json-boolean">${obj}</span>`;
      }
      if (typeof obj === 'number') {
        return `<span class="json-number">${obj}</span>`;
      }
      if (typeof obj === 'string') {
        const escaped = obj.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        return `<span class="json-string">"${escaped}"</span>`;
      }
      if (Array.isArray(obj)) {
        if (obj.length === 0) return '<span class="json-bracket">[]</span>';
        const items = obj.map(item => spaces + '  ' + highlightJson(item, indent + 1)).join(',\n');
        return `<span class="json-bracket">[</span>\n${items}\n${spaces}<span class="json-bracket">]</span>`;
      }
      if (typeof obj === 'object') {
        const keys = Object.keys(obj);
        if (keys.length === 0) return '<span class="json-bracket">{}</span>';
        const items = keys.map(key => {
          const escapedKey = key.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
          return `${spaces}  <span class="json-key">"${escapedKey}"</span>: ${highlightJson(obj[key], indent + 1)}`;
        }).join(',\n');
        return `<span class="json-bracket">{</span>\n${items}\n${spaces}<span class="json-bracket">}</span>`;
      }
      return String(obj);
    }

    function showDetail(index) {
      const event = entries[index];
      if (!event) return;

      // Update selection
      selectedIndex = index;
      document.querySelectorAll('.log-entry.selected').forEach(el => el.classList.remove('selected'));
      const entryEl = document.querySelector(`.log-entry[data-index="${index}"]`);
      if (entryEl) entryEl.classList.add('selected');

      // Build detail content
      let html = `
        <div class="detail-section">
          <div class="detail-section-title">Event Info</div>
          <div class="detail-field">
            <span class="detail-field-name">Timestamp:</span>
            <span class="detail-field-value">${event.timestamp}</span>
          </div>
          <div class="detail-field">
            <span class="detail-field-name">Category:</span>
            <span class="detail-field-value">${event.category || 'unknown'}</span>
          </div>
          <div class="detail-field">
            <span class="detail-field-name">Type:</span>
            <span class="detail-field-value">${event.type}</span>
          </div>
          <div class="detail-field">
            <span class="detail-field-name">Source:</span>
            <span class="detail-field-value">${event.source || 'unknown'}</span>
          </div>
          ${event.specialist ? `
          <div class="detail-field">
            <span class="detail-field-name">Specialist:</span>
            <span class="detail-field-value">${event.specialist}</span>
          </div>
          ` : ''}
          ${event.method ? `
          <div class="detail-field">
            <span class="detail-field-name">Method:</span>
            <span class="detail-field-value">${event.method}</span>
          </div>
          ` : ''}
          ${event.requestId ? `
          <div class="detail-field">
            <span class="detail-field-name">Request ID:</span>
            <span class="detail-field-value" style="font-family: monospace; font-size: 10px;">${event.requestId}</span>
          </div>
          ` : ''}
          ${event.parentRequestId ? `
          <div class="detail-field">
            <span class="detail-field-name">Parent Request ID:</span>
            <span class="detail-field-value" style="font-family: monospace; font-size: 10px;">${event.parentRequestId}</span>
          </div>
          ` : ''}
          ${event.sessionId ? `
          <div class="detail-field">
            <span class="detail-field-name">Session ID:</span>
            <span class="detail-field-value">${event.sessionId}</span>
          </div>
          ` : ''}
        </div>
      `;

      if (event.data) {
        html += `
          <div class="detail-section">
            <div class="detail-section-title">Data</div>
            <div class="detail-json">${highlightJson(event.data)}</div>
          </div>
        `;
      }

      html += `
        <div class="detail-section">
          <div class="detail-section-title">Raw Event</div>
          <div class="detail-json">${highlightJson(event)}</div>
        </div>
      `;

      detailContent.innerHTML = html;
      detailPanel.classList.add('open');
    }

    function closeDetail() {
      detailPanel.classList.remove('open');
      selectedIndex = -1;
      document.querySelectorAll('.log-entry.selected').forEach(el => el.classList.remove('selected'));
    }

    function createEntryElement(event, index, isTreeView = false) {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.dataset.category = event.category || 'system';
      entry.dataset.index = index;

      const category = event.category || 'system';
      const source = event.source || '';
      const specialist = event.specialist || '';
      const method = event.method || '';
      const data = event.data;
      const emoji = getTypeEmoji(event.type);

      let contentHtml = '';
      if (source) contentHtml += `<span class="source ${source}">${source}</span>`;
      if (specialist) contentHtml += `<span class="specialist">[${specialist}]</span>`;
      if (method) contentHtml += `<span class="method">${method}</span>`;
      if (data) contentHtml += `<span class="data">${formatData(data)}</span>`;

      if (isTreeView) {
        entry.innerHTML = `
          <span class="timestamp">${formatTime(event.timestamp)}</span>
          <span class="category ${category}">${category}</span>
          <span class="type ${event.type}">${emoji} ${event.type}</span>
          <span class="content">${contentHtml}</span>
        `;
      } else {
        entry.innerHTML = `
          <span class="timestamp">${formatTime(event.timestamp)}</span>
          <span class="category ${category}">${category}</span>
          <span class="type ${event.type}">${emoji} ${event.type}</span>
          <span class="content">${contentHtml}</span>
        `;
      }

      entry.addEventListener('click', (e) => {
        e.stopPropagation();
        showDetail(index);
      });

      if (index === selectedIndex) {
        entry.classList.add('selected');
      }

      return entry;
    }

    // Build tree structure from events
    function buildTree() {
      // Group events by requestId
      const byRequestId = new Map();
      const rootEvents = []; // Events with requestId but no parentRequestId (orchestrator starts)
      const orphanEvents = []; // Events without requestId

      for (let i = 0; i < entries.length; i++) {
        const event = entries[i];
        if (!shouldShow(event)) continue;

        if (event.requestId) {
          if (!byRequestId.has(event.requestId)) {
            byRequestId.set(event.requestId, { events: [], children: [] });
          }
          byRequestId.get(event.requestId).events.push({ event, index: i });

          // If this is a root event (orchestrator request with no parent)
          if (!event.parentRequestId && event.type === 'request' && event.category === 'orchestrator') {
            rootEvents.push(event.requestId);
          }
        } else {
          orphanEvents.push({ event, index: i });
        }
      }

      // Link children to parents
      for (const [requestId, data] of byRequestId) {
        // Find if any event in this request has a parentRequestId
        const firstEvent = data.events[0]?.event;
        if (firstEvent?.parentRequestId && byRequestId.has(firstEvent.parentRequestId)) {
          byRequestId.get(firstEvent.parentRequestId).children.push(requestId);
        }
      }

      return { byRequestId, rootEvents, orphanEvents };
    }

    function renderTreeNode(requestId, byRequestId, depth = 0) {
      const data = byRequestId.get(requestId);
      if (!data) return null;

      const container = document.createElement('div');
      container.className = depth === 0 ? 'tree-root' : 'tree-node';
      container.dataset.requestId = requestId;

      // Render events for this request
      for (const { event, index } of data.events) {
        const entry = createEntryElement(event, index, true);

        // Add toggle button for root/spawn events
        if (depth === 0 && event.type === 'request') {
          const toggle = document.createElement('span');
          toggle.className = 'tree-toggle';
          toggle.innerHTML = '▼';
          toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            container.classList.toggle('collapsed');
            toggle.innerHTML = container.classList.contains('collapsed') ? '▶' : '▼';
          });
          entry.insertBefore(toggle, entry.firstChild);
        }

        container.appendChild(entry);
      }

      // Render children (specialist requests)
      if (data.children.length > 0) {
        const childContainer = document.createElement('div');
        childContainer.className = 'tree-children';

        for (const childRequestId of data.children) {
          const childNode = renderTreeNode(childRequestId, byRequestId, depth + 1);
          if (childNode) {
            childContainer.appendChild(childNode);
          }
        }

        container.appendChild(childContainer);
      }

      return container;
    }

    function renderFlatView() {
      logContainer.innerHTML = '';
      let visibleCount = 0;

      for (let i = 0; i < entries.length; i++) {
        const event = entries[i];
        if (shouldShow(event)) {
          const entry = createEntryElement(event, i);
          logContainer.appendChild(entry);
          visibleCount++;
        }
      }

      if (visibleCount === 0 && entries.length > 0) {
        logContainer.innerHTML = '<div class="empty-state">No events match current filters</div>';
      } else if (entries.length === 0) {
        logContainer.innerHTML = '<div class="empty-state">Waiting for events...</div>';
      }
    }

    function renderTreeView() {
      logContainer.innerHTML = '';
      const { byRequestId, rootEvents, orphanEvents } = buildTree();

      // Render root events (orchestrator requests) as trees
      for (const requestId of rootEvents) {
        const tree = renderTreeNode(requestId, byRequestId, 0);
        if (tree) {
          logContainer.appendChild(tree);
        }
      }

      // Render orphan events (no requestId) at the bottom
      if (orphanEvents.length > 0) {
        for (const { event, index } of orphanEvents) {
          const entry = createEntryElement(event, index, true);
          logContainer.appendChild(entry);
        }
      }

      // Handle requests that have events but weren't in rootEvents
      // (e.g., specialists without a parent, or requests that started mid-stream)
      for (const [requestId, data] of byRequestId) {
        if (!rootEvents.includes(requestId)) {
          // Check if this request is a child of another
          const firstEvent = data.events[0]?.event;
          if (!firstEvent?.parentRequestId || !byRequestId.has(firstEvent.parentRequestId)) {
            // This is an orphan request tree
            const tree = renderTreeNode(requestId, byRequestId, 0);
            if (tree && !logContainer.contains(tree)) {
              logContainer.appendChild(tree);
            }
          }
        }
      }

      if (logContainer.children.length === 0) {
        if (entries.length > 0) {
          logContainer.innerHTML = '<div class="empty-state">No events match current filters</div>';
        } else {
          logContainer.innerHTML = '<div class="empty-state">Waiting for events...</div>';
        }
      }
    }

    function addEntry(event) {
      emptyState.style.display = 'none';
      entries.push(event);

      // For efficiency, only do full re-render in tree view
      // In flat view, just append
      if (currentView === 'flat') {
        if (shouldShow(event)) {
          const index = entries.length - 1;
          const entry = createEntryElement(event, index);
          logContainer.appendChild(entry);
          logContainer.scrollTop = logContainer.scrollHeight;
        }
      } else {
        rerender();
      }
    }

    function rerender() {
      if (currentView === 'flat') {
        renderFlatView();
      } else {
        renderTreeView();
      }
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function clearLog() {
      entries = [];
      selectedIndex = -1;
      closeDetail();
      logContainer.innerHTML = '<div class="empty-state">Log cleared</div>';
    }

    function setConnected(connected) {
      statusDot.className = 'status-dot' + (connected ? ' connected' : '');
      statusText.textContent = connected ? 'Connected' : 'Disconnected';
    }

    function connect() {
      if (eventSource) {
        eventSource.close();
      }

      const url = 'https://localhost:3847/debug';

      try {
        eventSource = new EventSource(url);

        eventSource.onopen = () => {
          console.log('EventSource onopen fired');
          setConnected(true);
        };

        eventSource.onmessage = (e) => {
          if (!statusDot.classList.contains('connected')) {
            console.log('Setting connected via onmessage');
            setConnected(true);
          }
          try {
            const event = JSON.parse(e.data);
            addEntry(event);
          } catch (err) {
            console.error('Failed to parse event:', err);
          }
        };

        eventSource.onerror = (err) => {
          setConnected(false);
          console.error('EventSource error:', err);
          eventSource.close();
          setTimeout(connect, 3000);
        };
      } catch (err) {
        setConnected(false);
        console.error('Failed to connect:', err);
        setTimeout(connect, 3000);
      }
    }

    function reconnect() {
      connect();
    }

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeDetail();
      }
    });

    // Start connection
    connect();
  </script>
</body>
</html>
